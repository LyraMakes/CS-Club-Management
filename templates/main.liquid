<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Computer Science Club Finances</title>
    <!-- meta refresh -->
    <!-- <meta http-equiv="refresh" content="10"> -->

    <!-- jQuery -->
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.5.1/jquery.min.js"></script>

    <script>

        (function(seconds) {
            var refresh,       
                intvrefresh = function() {
                    clearInterval(refresh);
                    refresh = setTimeout(function() {
                       location.href = location.href;
                    }, seconds * 1000);
                };
        
            $(document).on('keypress click', function() { intvrefresh() });
            intvrefresh();
        
        }(15)); // define here seconds


        function onLoad(){
            let checkboxes = document.querySelectorAll("input[type=checkbox]");
            checkboxes.forEach( elt => {
                elt.checked = true;
            })

            // Get the last sort type from the URL parameters
            var urlParams = new URLSearchParams(window.location.search);
            var lastSort = urlParams.get('sort');
            var lastOrder = urlParams.get('order');

            // Get the current filters from the header
            var excludeType = urlParams.get('excludeType');
            var excludeStatus = urlParams.get('excludeStatus');
        
            // For each item in excludeType, uncheck the corresponding checkbox
            if(excludeType != null){
                excludeType = excludeType.split(",");
                excludeType.forEach( elt => {
                    let box = document.getElementById(elt);
                    if(box != null){
                        box.checked = false;
                    }
                })
            }

            if(excludeStatus != null){
                excludeStatus = excludeStatus.split(",");
                excludeStatus.forEach( elt => {
                    let box = document.getElementById(elt);
                    if(box != null){
                        box.checked = false;
                    }
                })
            }
        }

        function sort(type){
            // Get the last sort type from the URL parameters
            var urlParams = new URLSearchParams(window.location.search);
            var lastSort = urlParams.get('sort');
            var lastOrder = urlParams.get('order');

            if(lastOrder == null){
                lastOrder = "asc";
            }
            if (lastSort == null){
                lastSort = "id";
            }

            // Get the current filters from the header
            var excludeType = urlParams.get('excludeType');
            var excludeStatus = urlParams.get('excludeStatus');

            // Apply the sort
            lastOrder = (lastOrder == "asc") ? "desc" : "asc";
            window.location.href = "/?sort=" + type + "&order=" + lastOrder + "&excludeType=" + excludeType + "&excludeStatus=" + excludeStatus;
        }

        function filter(){
            // Get the last sort type from the URL parameters
            var urlParams = new URLSearchParams(window.location.search);
            var lastSort = urlParams.get('sort');
            var lastOrder = urlParams.get('order');

            if(lastOrder == null){
                lastOrder = "asc";
            }
            if (lastSort == null){
                lastSort = "id";
            }

            // Get the current filters from the header
            var excludeType = urlParams.get('excludeType');
            var excludeStatus = urlParams.get('excludeStatus');

            // Get the current filter values
            var type = [];
            var status = [];
            var checkboxes = document.querySelectorAll("input[type=checkbox]");
            checkboxes.forEach( elt => {
                if(!elt.checked){
                    if(elt.id == "invoice" || elt.id == "c_invoice" || elt.id == "sga_budget"){
                        type.push(elt.id);
                    }
                    else{
                        status.push(elt.id);
                    }
                }
            })

            // Apply the filters
            window.location.href = "/?sort=" + lastSort + "&order=" + lastOrder + "&excludeType=" + type + "&excludeStatus=" + status;
        }
    </script>
</head>
<body onload="onLoad()">
    <!-- Add filters -->
    <fieldset>
        <legend>Filters</legend>
        <fieldset>
            <legend>Status</legend>
            <input type="checkbox" name="pending" id="pending">
            <label for="pending">Pending</label> <br>

            <input type="checkbox" name="open" id="open">
            <label for="open">Open</label> <br>

            <input type="checkbox" name="granted" id="granted">
            <label for="granted">Granted</label> <br>

            <input type="checkbox" name="paid" id="paid">
            <label for="paid">Paid</label> <br>

            <input type="checkbox" name="closed" id="closed">
            <label for="closed">Closed</label> <br>

            <input type="checkbox" name="cancelled" id="cancelled">
            <label for="cancelled">Cancelled</label> <br>
        </fieldset>
        <fieldset>
            <legend>Type</legend>
            <input type="checkbox" name="invoice" id="invoice">
            <label for="invoice">Invoice</label> <br>
            <input type="checkbox" name="c_invoice" id="c_invoice">
            <label for="c_invoice">Credit Invoice</label> <br>
            <input type="checkbox" name="sga_budget" id="sga_budget">
            <label for="sga_budget">SGA Budget Request</label> <br>
        </fieldset>
        <button onclick="filter()">Apply Filters</button>
    </fieldset>
    <button onclick="window.location.href='/new/'">New Finance Record</button>
    <table class="MainTable">
        <tr>
            <th onclick="sort('id')">Item ID</th>
            <th onclick="sort('type')">Record Type</th>
            <th onclick="sort('creator')">Created By</th>
            <th onclick="sort('status')">Status</th>
            <th onclick="sort('item_count')">Items</th>
            <th onclick="sort('total')">Total</th>
            <th>Options</th>
        </tr>
    {% for item in records %}
        <tr>
            <td style="text-align: center;">{{item.id}}</td>
            <td>{% if item.type=="invoice" %}
                Invoice
            {% else %}
                {% if item.type=="sga_budget" %}
                    SGA Budget Request
                {% else %}
                    {% if item.type=="c_invoice" %}
                        Credit Invoice
                    {% else %}
                        Other
                    {% endif %}
                {% endif %}
            {% endif %}</td>
            <td>{{item.creator}}</td>
            <td>{{item.status}}</td>
            <td>{{item.li | size}}</td>
            <td>{{item.total}}</td>
            <td><button onclick="window.open('/view/{{item.id}}')">Open</button><button onclick="window.open('/edit/{{item.id}}')">Edit</button></td>
        </tr>
    {% endfor %}
    </table>
</body>
<style>
    .MainTable{
        width: 75%
    }
    table, td, th{
        border-collapse: collapse;
        border: 1px solid black;
        text-transform: capitalize;
    }
    th, label, input{
        cursor: pointer;
    }
</style>
</html>